<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "com.inspur.icity.microsrv.app.logic.repo.ApplicationRepo">
    <!--<cache type = "com.inspur.icity.microsrv.core.cache.RedisCache"/>-->
    <update id = "flushCache" flushCache = "true">
        UPDATE app_application SET id = 0 WHERE id = 0;
    </update>

    <!-- (空两行) -->
    <!-- (空两行) -->
    <!-- 增 -->
    <insert id = "add" useGeneratedKeys = "true"  keyProperty = "id" flushCache = "true">
        <![CDATA[
            INSERT INTO app_application
                (
                 cityCode,
                 module,
                 type,
                 code,
                 name,
                 description,
                 imgUrl,
                 gotoUrl,
                 disable,
                 visible,
                 sequence,
                 isLocal,
                 level,
                 isCollection,
                 isShare,
                 isSupportShortcut,
                 shortcutImg,
                 scope,
                 orgGroup,
                 icon,
                 infoSource,
                 gotoUrlCopy,
                 security,
                 isShowTopTitle,
                 createTime,
                 updateTime
                )
            VALUES
                (
                 #{cityCode},
                 #{module},
                 #{type},
                 #{code},
                 #{name},
                 #{description},
                 #{imgUrl},
                 #{gotoUrl},
                 #{disable},
                 #{visible},
                 #{sequence},
                 #{isLocal},
                 #{level},
                 #{isCollection},
                 #{isShare},
                 #{isSupportShortcut},
                 #{shortcutImg},
                 #{scope},
                 #{orgGroup},
                 #{icon},
                 #{infoSource},
                 #{gotoUrlCopy},
                 #{security},
                 #{isShowTopTitle},
                 #{createTime},
                 #{updateTime}
                )
        ]]>
    </insert>

    <insert id = "synchronizationApp" useGeneratedKeys = "true"  keyProperty = "id" flushCache = "true">
        <![CDATA[
            INSERT INTO app_application
                (
                 id,
                 cityCode,
                 module,
                 type,
                 code,
                 name,
                 description,
                 imgUrl,
                 gotoUrl,
                 disable,
                 visible,
                 sequence,
                 isLocal,
                 level,
                 isCollection,
                 isShare,
                 isSupportShortcut,
                 shortcutImg,
                 scope,
                 orgGroup,
                 icon,
                 infoSource,
                 gotoUrlCopy,
                 security,
                 isShowTopTitle,
                 createTime,
                 updateTime
                )
            VALUES
                (
                 #{id},
                 #{cityCode},
                 #{module},
                 #{type},
                 #{code},
                 #{name},
                 #{description},
                 #{imgUrl},
                 #{gotoUrl},
                 #{disable},
                 #{visible},
                 #{sequence},
                 #{isLocal},
                 #{level},
                 #{isCollection},
                 #{isShare},
                 #{isSupportShortcut},
                 #{shortcutImg},
                 #{scope},
                 #{orgGroup},
                 #{icon},
                 #{infoSource},
                 #{gotoUrlCopy},
                 #{security},
                 #{isShowTopTitle},
                 #{createTime},
                 #{updateTime}
                )
        ]]>
    </insert>


    <!-- (空两行) -->
    <!-- (空两行) -->
    <!-- 删 -->
    <!--通过主键删除-->
    <delete id = "remove" flushCache = "true">
        DELETE FROM
            app_application
        WHERE
            id = #{id}
    </delete>

    <delete id = "delByCityModuleType" flushCache = "true">
        DELETE FROM
            app_application
        WHERE
            cityCode = #{cityCode}
            AND module = #{module}
            AND type = #{type}
    </delete>

    <!-- (空两行) -->
    <!-- (空两行) -->
    <!-- 改 -->

    <!--修改-->
    <update id = "update" flushCache = "true">
        <![CDATA[
            UPDATE
                app_application
            SET
                cityCode = #{cityCode},
                module = #{module},
                type = #{type},
                code = #{code},
                name = #{name},
                description = #{description},
                imgUrl = #{imgUrl},
                icon = #{icon},
                gotoUrl = #{gotoUrl},
                gotoUrlCopy = #{gotoUrlCopy},
                security = #{security},
                sequence = #{sequence},
                level = #{level},
                scope = #{scope},
                orgGroup = #{orgGroup},
                isLocal = #{isLocal},
                isShare = #{isShare},
                isSupportShortcut = #{isSupportShortcut},
                shortcutImg = #{shortcutImg},
                isCollection = #{isCollection},
                infoSource = #{infoSource},
                disable = #{disable},
                visible = #{visible},
                isShowTopTitle = #{isShowTopTitle},
                updateTime = #{updateTime}
            WHERE
                id = #{id}
        ]]>
    </update>

    <!--更新icon标签-->

    <update id = "updateIcon" flushCache = "true">
        <foreach collection = "appIdArray" item = "item" index = "index" open = "" close = "" separator = ";">
        UPDATE
            app_application
        SET
            icon = #{icon}
        WHERE
            id = #{item}
        </foreach>
    </update>

    <!--修改排序-->
    <update id = "updateSequence" flushCache = "true">
        UPDATE
            app_application
        SET
            sequence = #{seq}
        WHERE
            id = #{id}
    </update>

    <!--修改收藏-->
    <update id = "updateCollection" flushCache = "true">
        UPDATE
            app_application
        SET
            isCollection = #{isCollection}
        WHERE
            id = #{id}
    </update>

    <update id = "updateSequenceBatch"  parameterType = "java.util.List">
        <foreach collection = "list" item = "item" index = "index" open = "" close = "" separator = ";">
            UPDATE
                app_application
            <set>
                sequence = #{item.sequence}
            </set>
            WHERE
                id = #{item.id}
        </foreach>
    </update>

    <update id = "updateTypeBatch" flushCache = "true">
        UPDATE
            app_application
        SET
            cityCode = #{newCityCode},
            module = #{newModule},
            type = #{newType}
        WHERE
            cityCode = #{oldCityCode}
            AND module = #{oldModule}
            AND type = #{oldType}
    </update>

    <!-- (空两行) -->
    <!-- (空两行) -->
    <!-- 查 -->
    <!-- 按id查询一条 -->
    <select id = "get" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            isSupportShortcut,
            shortcutImg,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            orgGroup,
            isLocal,
            isCollection,
            isShare,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
        WHERE
            id = #{id}
    </select>

    <!-- 分页查询 -->
    <select id = "find" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            isSupportShortcut,
            shortcutImg,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            orgGroup,
            isLocal,
            isCollection,
            isShare,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
    </select>

    <!--2.4.3老接口调用-->
    <select id = "getAppLstByCityCodeAndCustId" resultType = "Map" useCache = "false">
        SELECT
            ap.id,
            ap.imgUrl,
            ap.name,
            ap.type,
            ca.appId AS hasAppId,
            ap.module,
            ap.security,
            ap.isShowTopTitle
        FROM
            app_application ap
            LEFT JOIN cust_app ca
                 ON ca.appId = ap.id
                    AND ca.custId = #{custId}
        WHERE
            ap.cityCode = #{cityCode}
        ORDER BY
            ap.sequence,
            ap.type
    </select>

    <!--获取所有的字段-->
    <select id = "getAppLstByCityModuleTypeEtc" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            isSupportShortcut,
            shortcutImg,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            orgGroup,
            isLocal,
            isCollection,
            isShare,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
        WHERE
            1 = 1
            <if test = "cityCode != null and cityCode  != ''">
                AND cityCode = #{cityCode}
            </if>
            <if test = "module != null and module  != ''">
                AND module = #{module}
            </if>
            <if test = "type != null and type  != ''">
                AND type = #{type}
            </if>
            <if test = "onLineStatus != null" >
                AND disable = #{onLineStatus}
            </if>
            <if test = "name != null and name  != ''">
                AND name LIKE "%${name}%"
            </if>
        ORDER BY
            sequence
    </select>

    <select id = "getAppLstByCityModuleForClassification" resultType = "Map" useCache = "false">
        SELECT
            type,
            name,
            sequence
        FROM
            app_type
        WHERE
            disable = 0
            AND cityCode = #{cityCode}
        <if test="module !=null and module !=''">
            AND module = #{module}
        </if>
        ORDER BY
            sequence ASC
    </select>

    <select id = "getPublicAppLstForAppSquare" resultType = "Map">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            isLocal,
            isCollection,
            isShare,
            isSupportShortcut,
            shortcutImg,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
        WHERE
            disable = 0
            AND visible = 0
            AND cityCode = #{cityCode}
            AND module = #{module}
            AND scope = 'person'
        ORDER BY
            sequence ASC
    </select>

    <select id = "getGroupAppLstForAppSquare" resultType = "Map">
        SELECT
            app.id,
            app.cityCode,
            app.module,
            app.type,
            app.code,
            app.name,
            app.description,
            app.imgUrl,
            app.icon,
            app.gotoUrl,
            app.gotoUrlCopy,
            app.security,
            app.sequence,
            app.visible,
            app.level,
            app.scope,
            app.isLocal,
            app.isCollection,
            app.isShare,
            app.isSupportShortcut,
            app.shortcutImg,
            app.infoSource,
            app.disable,
            app.isShowTopTitle,
            app.createTime,
            app.updateTime
        FROM
            app_application_group appG,
            app_application app
        WHERE
            appG.groupCode IN
                        <foreach collection = "groupCodeLst" item = "item" index = "index" open = "(" separator = "," close = ")">
                            #{item}
                        </foreach>
            AND appG.appId = app.id
            AND app.disable = 0
            AND app.visible = 0
            AND app.cityCode = #{cityCode}
            AND app.module = #{module}
            AND app.scope = 'group'
        ORDER BY
        app.sequence ASC
    </select>

    <select id = "getOrganAppLstForAppSquare" resultType = "Map">
        SELECT
            app.id,
            app.cityCode,
            app.module,
            app.type,
            app.code,
            app.name,
            app.description,
            app.imgUrl,
            app.icon,
            app.gotoUrl,
            app.gotoUrlCopy,
            app.security,
            app.sequence,
            app.visible,
            app.level,
            app.scope,
            app.isLocal,
            app.isCollection,
            app.isShare,
            app.isSupportShortcut,
            app.shortcutImg,
            app.infoSource,
            app.disable,
            app.isShowTopTitle,
            app.createTime,
            app.updateTime
        FROM
            app_application_org appO,
            app_application app
        WHERE
            appO.orgCode IN
                    <foreach collection = "organCodeLst" item = "item" index = "index" open = "(" separator = "," close = ")">
                        #{item}
                    </foreach>
            AND appO.appId = app.id
            AND app.disable = 0
            AND app.visible = 0
            AND app.cityCode = #{cityCode}
            AND app.module = #{module}
            AND app.scope = 'org'
        ORDER BY
            sequence ASC
    </select>

    <select id = "getAppLstByIdLst" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            isLocal,
            isCollection,
            isShare,
            isSupportShortcut,
            shortcutImg,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
        WHERE
            id IN
                <foreach collection = "array" item = "item" index = "index" open = "(" separator = "," close = ")">
                    #{item}
                </foreach>
    </select>

    <!--搜索符合条件的应用-->
    <select id = "searchAppByKeyword" resultType = "Map" useCache = "false">
        SELECT
            app.id,
            app.name appName,
            app.imgUrl,
            app.gotoUrl,
            app.code,
            app.isShare,
            app.isSupportShortcut,
            app.shortcutImg,
            app.level,
            app.description,
            appT.name type,
            app.security,
            app.isShowTopTitle
        FROM
            app_application app,
            app_type appT
        WHERE
            app.disable = 0
            AND app.cityCode = #{cityCode}
            AND app.module = #{module}
            AND app.scope = #{appScope}
            AND app.name LIKE "%${keyword}%"
            AND app.cityCode = appT.cityCode
            AND app.type = appT.type
        ORDER BY
            app.sequence ASC
    </select>

    <select id = "getAppLstByCityAndKeyword" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
            id,
            cityCode,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            icon,
            gotoUrl,
            gotoUrlCopy,
            security,
            sequence,
            visible,
            level,
            scope,
            isLocal,
            isCollection,
            isShare,
            isSupportShortcut,
            shortcutImg,
            infoSource,
            disable,
            isShowTopTitle,
            createTime,
            updateTime
        FROM
            app_application
        WHERE
            disable = 0
            AND cityCode = #{cityCode}
            AND (name LIKE "%${keyword}%" OR description LIKE "%${keyword}$%")
    </select>

    <select id = "getAppLstByCity" resultType = "com.inspur.icity.microsrv.base.model.Application">
        SELECT
        id,
        cityCode,
        module,
        type,
        code,
        name,
        description,
        imgUrl,
        icon,
        gotoUrl,
        gotoUrlCopy,
        security,
        sequence,
        visible,
        level,
        scope,
        isLocal,
        isCollection,
        isShare,
        isSupportShortcut,
        shortcutImg,
        infoSource,
        disable,
        isShowTopTitle,
        createTime,
        updateTime
        FROM
        app_application
        WHERE
        cityCode = #{cityCode}
    </select>

    <!--图标详情-->
    <select id = "getAppLstForIconManage" resultType = "map" useCache = "false">
        SELECT
            app.id,
            app.name,
            app.description,
            app.imgUrl,
            app.module,
            app.type,
            app.gotoUrl,
            app.security,
            app.code,
            app.sequence,
            app.cityCode,
            bc.name AS cityName,
            app.isLocal,
            app.isShare,
            app.isSupportShortcut,
            app.shortcutImg,
            app.infoSource,
            app.disable,
            app.visible,
            app.level,
            app.scope,
            app.orgGroup,
            app.icon,
            app.isShowTopTitle,
            app.createTime,
            appT.name AS imgType,
            ai.name iconName,
            ai.imgUrl iconUrl
        FROM
            app_application app
            LEFT JOIN app_type appT
                ON  app.cityCode = appT.cityCode
                    AND app.module = appT.module
                    AND app.type = appT.type
            LEFT JOIN base_city bc
                ON app.cityCode = bc.code
            LEFT JOIN app_icon ai
                ON app.icon = ai.id
        WHERE
            1=1
            <if test = "cityCode != null and cityCode  != ''" >
                AND app.cityCode = #{cityCode}
            </if>
            <if test = "cityCodeLst != null" >
                AND app.cityCode IN
                            <foreach collection = "cityCodeLst" index = "index" item = "item" open = "(" separator="," close=")">
                                #{item}
                            </foreach>
            </if>
            <if test = "disable != null and disable != ''" >
                AND app.disable  = #{disable}
            </if>
            <if test = "type != null and type  != ''" >
                AND app.type = #{type}
            </if>
            <if test = "createTime != null and createTime  != ''" >
                AND app.createTime = #{createTime}
            </if>
            <if test = "name != null and name  != ''" >
                AND app.name LIKE "%${name}%"
            </if>
        ORDER BY
            app.sequence ASC,
            app.createTime DESC
    </select>

    <!--判断某城市下code是否重复-->
    <select id = "countAppByCityAndCode" resultType = "int">
        SELECT
            COUNT(id) num
        FROM
            app_application
        WHERE
            cityCode = #{cityCode}
            AND code = #{code}
    </select>

    <!--根据城市和应用Code获取应用-->
    <select id="searchAppByCodeAndCityCode" resultType="Map">
        SELECT id
        FROM app_application
        WHERE code = #{code}
        and cityCode=#{cityCode}
    </select>

    <!--查询顺序-->
    <select id = "getMaxSeq" resultType = "int">
        SELECT
            MAX(sequence) maxSeq
        FROM
            app_application
        WHERE
            cityCode = #{cityCode}
            AND type = #{type}
            AND disable = #{disable}
    </select>

    <!-- 判断指定城市中是否使用了指定的应用功能类型 -->
    <select id = "countAppByCityAndType" resultType = "int">
        SELECT
            COUNT(id) num
        FROM
            app_application
        WHERE
            cityCode = #{cityCode}
            AND type = #{type}
    </select>

    <!--根据应用Id获取应用-->
    <select id="getAppInfoById" resultType="map">
        SELECT
        id,
        module,
        type,
        code,
        name,
        description,
        imgUrl,
        gotoUrl,
        security,
        level,
        sequence,
        isLocal,
        isShare,
        isSupportShortcut,
        shortcutImg,
        security,
        isShowTopTitle,
        disable
        FROM app_application
        where id=#{id}
    </select>

    <select id = "getAppInfoByIdAndCity" resultType = "map">
        SELECT
            id,
            module,
            type,
            code,
            name,
            description,
            imgUrl,
            gotoUrl,
            security,
            sequence,
            isLocal,
            isSupportShortcut,
            shortcutImg,
            isShowTopTitle,
            isShare
        FROM app_application
        WHERE cityCode LIKE "%${cityCode}%"
        AND id = #{id}
    </select>


    <!-- 根据内容字典列表信息 -->
    <select id = "findAppByIdsAndCondition" parameterType = "java.util.HashMap" resultType = "map">
        SELECT
        aa.id,
        aa.name,
        aa.description,
        aa.security,
        aa.type,
        aa.sequence,
        aa.cityCode,
        aa.isLocal,
        aa.isShowTopTitle,
        aa.createTime,
        ap.name AS imgType,
        bc.name AS cityName
        FROM
        app_application aa
        LEFT JOIN
        app_type ap
        ON 	aa.type = ap.type
        AND ap.cityCode = aa.cityCode
        AND aa.module = ap.module,
        base_city bc
        WHERE
        aa.cityCode = bc.code
        AND bc.disable = 0
        AND aa.id IN
        <foreach collection = "appIdLst" index = "index" item = "item" open = "(" separator = "," close = ")">#{item}
        </foreach>

        <if test = "name != null and name != ''">
            AND aa.name LIKE "%${name}%"
        </if>
        <if test = "cityCode != null and cityCode != ''">
            AND aa.cityCode = #{cityCode}
        </if>
        <if test = "type!=null and type != ''">
            AND aa.type = #{type}
        </if>
        <if test = "createTime != null and createTime != ''">
            AND aa.createTime LIKE "%${createTime}%"
        </if>
        AND aa.disable = 0
    </select>

</mapper>